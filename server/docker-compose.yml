version: '3'
services:
  emqx1:
    image: emqx:5.0.26
    container_name: emqx1
    environment:
    - "EMQX_NODE_NAME=emqx@node1.emqx.io"
    - "EMQX_CLUSTER__DISCOVERY_STRATEGY=static"
    - "EMQX_CLUSTER__STATIC__SEEDS=[emqx@node1.emqx.io,emqx@node2.emqx.io]"
    healthcheck:
      test: ["CMD", "/opt/emqx/bin/emqx_ctl", "status"]
      interval: 5s
      timeout: 25s
      retries: 5
    networks:
      emqx-bridge:
        aliases:
        - node1.emqx.io
    ports:
      - 1883:1883
      - 8083:8083
      - 8084:8084
      - 8883:8883
      - 18083:18083 
    volumes:
      - emqx1_data:/opt/emqx/data

  emqx2:
    image: emqx:5.0.26
    container_name: emqx2
    environment:
    - "EMQX_NODE_NAME=emqx@node2.emqx.io"
    - "EMQX_CLUSTER__DISCOVERY_STRATEGY=static"
    - "EMQX_CLUSTER__STATIC__SEEDS=[emqx@node1.emqx.io,emqx@node2.emqx.io]"
    healthcheck:
      test: ["CMD", "/opt/emqx/bin/emqx_ctl", "status"]
      interval: 5s
      timeout: 25s
      retries: 5
    networks:
      emqx-bridge:
        aliases:
        - node2.emqx.io
    volumes:
      - emqx2_data:/opt/emqx/data


  nginx_proxy:
    build:
      context: .
      dockerfile: ./apps/nginx_proxy/Dockerfile
    ports:
      - "80:80"
      - "443:443"
      - "2202:2202"
    volumes:
      - ./apps/nginx_proxy/nginx.conf:/etc/nginx/nginx.conf
      - ./log/nginx:/var/log/nginx
    depends_on:
      - fb_notifications_service
      - payments_service
      - store_service
      - verify_id_service
      - cdn_service
    networks:
      - local_bridge
  
  fb_notifications_service:
    build:
      context: .
      dockerfile: ./apps/notifications/Dockerfile
    volumes:
      - ./log/notifications:/app/log/notifications
    environment:
      - PORT=${FB_NOTIF_PORT}
      - NODE_ENV=production
      - FB_NOTIF_PORT=${FB_NOTIF_PORT}
    restart: unless-stopped
    networks:
      - local_bridge

  
  payments_service:
    build:
      context: .
      dockerfile: ./apps/payments/Dockerfile
    volumes:
      - ./log/payments:/app/log/payments
    environment:
      - PORT=${PAYMENTS_PORT}
      - NODE_ENV=production
      - PAYMENTS_PORT=${PAYMENTS_PORT}
      - PAYMENTS_TOKEN=${PAYMENTS_TOKEN}
      - PAYMENT_EVENTS_SECRET=${PAYMENT_EVENTS_SECRET}
    restart: unless-stopped
    networks:
      - local_bridge

  
  store_service:
    build:
      context: .
      dockerfile: ./apps/store/Dockerfile
    volumes:
      - ./apps/store/db:/app/apps/store/db
      - ./log/store:/app/log/store
    environment:
      - PORT=${STORE_PORT}
      - NODE_ENV=production
      - STORE_PORT=${STORE_PORT}
    restart: unless-stopped
    networks:
      - local_bridge

    
  cdn_service:
    build:
      context: .
      dockerfile: ./apps/cdn/Dockerfile
    volumes:
      - ./apps/cdn/root:/app/apps/cdn/root
      - ./apps/cdn/static:/app/apps/cdn/static
      - ./log/cdn:/app/log/cdn
    environment:
      - PORT=${CDN_PORT}
    restart: unless-stopped
    networks:
      - local_bridge

  
  verify_id_service:
    build:
      context: .
      dockerfile: ./apps/verifyId/Dockerfile
    volumes:
      - ./log/verify_id:/app/log/verify_id
    environment:
      - PORT=${VERIFYID_PORT}
      - NODE_ENV=production
      - VERIFYID_PORT=${VERIFYID_PORT}
    restart: unless-stopped
    networks:
      - local_bridge


volumes:
  emqx1_data:
    driver: local
  emqx2_data:
    driver: local


networks:
  emqx-bridge:
    driver: bridge
  local_bridge:
    driver: bridge